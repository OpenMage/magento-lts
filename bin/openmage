#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * @copyright  For copyright and license information, read the COPYING.txt file.
 * @link       /COPYING.txt
 * @license    Open Software License (OSL 3.0)
 * @package    Mage_Core
 */

use Symfony\Component\Console\Application;

class OpenMage
{
    /**
     * OpenMage Root path
     */
    protected string $rootPath = '';

    /**
     * Initialize application with code (store, website code)
     */
    protected string $appCode = 'admin';

    /**
     * Initialize application code type (store, website, store_group)
     */
    protected string $appType = 'store';

    /**
     * Initialize application and parse input parameters
     */
    public function __construct()
    {
        require_once $this->getRootPath() . 'app' . DIRECTORY_SEPARATOR . 'Mage.php';

        $this->rootPath = dirname(__DIR__) . DIRECTORY_SEPARATOR;

        Mage::app($this->appCode, $this->appType);
        $this->applyPhpVariables();
    }

    /**
      * @throws Exception
     */
    public function setup(): void
    {
        $application = new Application();

        $files = glob('app/code/*/*/*/Command/*.php');

        // get claasses from files
        $files = array_map(function ($file) {
            return str_replace(['/', '.php'], ['_', ''], substr($file, strlen('app/code/core/')));
        }, $files);


        var_dump($files);
        $commands = Mage::getStoreConfig('console');
        $commands = Mage::getStoreConfig('console');
        foreach ($commands as $module => $moduleCommands) {
            foreach ($moduleCommands as $commandClass) {
                $class = Mage::getModel($commandClass);
                if (!$class) {
                    // echo "{$commandClass} not found\n";
                    continue;
                }

                $application->add(Mage::getModel($commandClass));
            }
        }

        $application->run();
    }

    /**
     * Get Magento Root path (with last directory separator)
     */
    protected function getRootPath(): string
    {
        return $this->rootPath;
    }

    /**
     * Parse .htaccess file and apply php settings to shell script
     */
    protected function applyPhpVariables(): void
    {
        $htaccess = $this->getRootPath() . '.htaccess';
        if (file_exists($htaccess)) {
            // parse htaccess file
            $data = file_get_contents($htaccess);
            $matches = [];
            preg_match_all('#^\s+?php_value\s+([a-z_]+)\s+(.+)$#siUm', $data, $matches, PREG_SET_ORDER);
            if ($matches) {
                foreach ($matches as $match) {
                    @ini_set($match[1], str_replace("\r", '', $match[2]));
                }
            }
            preg_match_all('#^\s+?php_flag\s+([a-z_]+)\s+(.+)$#siUm', $data, $matches, PREG_SET_ORDER);
            if ($matches) {
                foreach ($matches as $match) {
                    @ini_set($match[1], str_replace("\r", '', $match[2]));
                }
            }
        }
    }
}

$commands = new OpenMage();

try {
    $commands->setup();
} catch (Exception $exception) {
    echo 'Error: ' . $exception->getMessage() . "\n";
}
