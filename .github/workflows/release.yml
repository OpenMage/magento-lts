name: Release builder

on:
  release:
    types: [created]

jobs:
  release_build:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: ['7.3', '7.4', '8.0', '8.1']
    steps:
    - name: Install PHP ${{ matrix.php-versions }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
    - name: "Checkout repository"
      uses: actions/checkout@master
    - name: "Switching to composer deploy strategy copy"
      run: sed -i 's/"magento-root-dir"/"magento-deploystrategy":"copy","magento-root-dir"/' composer.json
    - name: "Composer install"
      uses: MilesChou/composer-action/8.1@master
      with:
        args: install --ignore-platform-req=ext-* --no-dev
    - name: "Move Cm_Cache_Backend_Redis to /lib"
      run: mkdir -p lib/Cm/Cache/Backend; cp vendor/colinmollenhour/cache-backend-redis/Cm/Cache/Backend/* lib/Cm/Cache/Backend/
    - name: "Move mcryptcompat to /lib"
      run: mkdir -p lib/mcryptcompat; cp vendor/phpseclib/mcrypt_compat/lib/* lib/mcryptcompat/
    - name: "Move Crypt to /lib"
      run: mkdir -p lib/phpseclib; cp -R vendor/phpseclib/phpseclib/phpseclib/Crypt lib/phpseclib
    - name: "Move Emogrifier to /lib"
      run: mkdir -p lib/Pelago; cp -R vendor/pelago/emogrifier/src/* lib/Pelago/
    - name: "Reset composer.json"
      run: git checkout composer.json
    - name: "Removing vendor folder"
      run: sudo rm -rf vendor
    - name: "Create ZIP file"
      run: zip -rq openmage-${{ github.event.release.tag_name }}-php${{ matrix.php-versions }}.zip . -x ".git/*"
    - name: "Attach ZIP to GitHub release"
      uses: svenstaro/upload-release-action@master
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: openmage-${{ github.event.release.tag_name }}-php${{ matrix.php-versions }}.zip
        tag: ${{ github.event.release.tag_name }}
        overwrite: true
